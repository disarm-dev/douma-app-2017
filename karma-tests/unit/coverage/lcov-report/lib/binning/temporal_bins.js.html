<!doctype html>
<html lang="en">
<head>
    <title>Code coverage report for lib/binning/temporal_bins.js</title>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="../../prettify.css" />
    <link rel="stylesheet" href="../../base.css" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style type='text/css'>
        .coverage-summary .sorter {
            background-image: url(../../sort-arrow-sprite.png);
        }
    </style>
</head>
<body>
<div class='wrapper'>
  <div class='pad1'>
    <h1>
      <a href="../../index.html">all files</a> / <a href="index.html">lib/binning/</a> temporal_bins.js
    </h1>
    <div class='clearfix'>
      <div class='fl pad1y space-right2'>
        <span class="strong">84.13% </span>
        <span class="quiet">Statements</span>
        <span class='fraction'>53/63</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">42.11% </span>
        <span class="quiet">Branches</span>
        <span class='fraction'>8/19</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">93.75% </span>
        <span class="quiet">Functions</span>
        <span class='fraction'>15/16</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">87.72% </span>
        <span class="quiet">Lines</span>
        <span class='fraction'>50/57</span>
      </div>
    </div>
  </div>
  <div class='status-line high'></div>
<pre><table class="coverage">
<tr><td class="line-count quiet">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132</td><td class="line-coverage quiet"><span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-yes">12×</span>
<span class="cline-any cline-yes">12×</span>
<span class="cline-any cline-yes">12×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-yes">10×</span>
<span class="cline-any cline-yes">10×</span>
<span class="cline-any cline-yes">10×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">10×</span>
<span class="cline-any cline-yes">10×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-yes">10×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-yes">12×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">12×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-yes">10×</span>
<span class="cline-any cline-yes">12×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">10×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">22×</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">22×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">22×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">12×</span>
<span class="cline-any cline-yes">12×</span>
<span class="cline-any cline-yes">25×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span></td><td class="text"><pre class="prettyprint lang-js">const moment = require('moment')
const get = require('lodash.get')
&nbsp;
const MOMENT_INTERVALS = ['months', 'weeks']
&nbsp;
&nbsp;
&nbsp;
&nbsp;
const get_dates_ms_from_responses = (responses) =&gt; {
  const dates_ms = responses.map(response =&gt; {
    <span class="missing-if-branch" title="if path not taken" >I</span>if (!response.recorded_on) <span class="cstat-no" title="statement not covered" >return null</span>
    return moment(response.recorded_on).valueOf()
  }).filter(i =&gt; i).sort()
&nbsp;
  const start_date_ms = dates_ms[0] // epoch
  const end_date_ms = dates_ms[dates_ms.length - 1] // epoch
&nbsp;
  return {start_date_ms, end_date_ms}
}
&nbsp;
const bin_names_from_dates = ({responses, interval}) =&gt; {
  <span class="missing-if-branch" title="if path not taken" >I</span>if (!MOMENT_INTERVALS.includes(interval)) <span class="cstat-no" title="statement not covered" >throw new Error(`Invalid interval passed: ${interval}`)</span>
&nbsp;
  const {start_date_ms, end_date_ms}= get_dates_ms_from_responses(responses)
&nbsp;
  // Get unique bins
  let now_date_ms = start_date_ms
  let bin_names = []
&nbsp;
  while (now_date_ms &lt;= end_date_ms) {
    const bin_date = get_first_day_of({date: now_date_ms, interval})
    const formatted_date = format_as_bin_date(bin_date)
    bin_names.push(formatted_date)
&nbsp;
    const next_now = moment(bin_date).add(1, interval)
    now_date_ms = next_now.valueOf()
  }
&nbsp;
  return bin_names
}
&nbsp;
const get_temporally_binned_responses = ({responses, interval}) =&gt; {
  const bin_names = bin_names_from_dates({responses, interval})
  let bins = bin_names.map(name =&gt; ({time_slice: name, responses: []}))
&nbsp;
  responses.forEach(response =&gt; {
    const right_bin = find_bin_for({response, bins, interval})
&nbsp;
    right_bin.responses.push(response)
  })
&nbsp;
  return bins
}
&nbsp;
function responses_within_temporal_filter({responses, temporal_filter_definition}) {
&nbsp;
  // No start_date and no end_date, just return responses
  <span class="missing-if-branch" title="else path not taken" >E</span>if (!temporal_filter_definition.start_date &amp;&amp; !temporal_filter_definition.end_date) return responses
&nbsp;
  let {start_date_ms, end_date_ms} = <span class="cstat-no" title="statement not covered" >get_dates_ms_from_responses(responses)</span>
&nbsp;
<span class="cstat-no" title="statement not covered" >  start_date_ms = temporal_filter_definition.start_date || start_date_ms</span>
<span class="cstat-no" title="statement not covered" >  end_date_ms = temporal_filter_definition.end_date || end_date_ms</span>
&nbsp;
  // start_date, but no end_date --&gt; filter
  // end_date but no start_date --&gt; filter
  // both start_date and end_date --&gt; filter
<span class="cstat-no" title="statement not covered" >  return responses_within_date_filters = responses.filter(response =&gt; <span class="fstat-no" title="function not covered" >{</span></span>
    const response_date = <span class="cstat-no" title="statement not covered" >moment(response.recorded_on).valueOf()</span>
<span class="cstat-no" title="statement not covered" >    return (response_date &gt;= moment(start_date_ms).valueOf()) &amp;&amp; (response_date &lt;= moment(end_date_ms).valueOf())</span>
  })
}
&nbsp;
/**
 * Get temporal bins with aggregations
 * Defaults to monthly bins
 * @param responses
 * @param temporal_filter_definition { interval: ['months', 'weeks']}
 * @returns {*}
 */
const get_temporally_binned_aggregations = ({responses, temporal_filter_definition = {}}) =&gt; {
  // Find relevant responses (i.e. within temporal filter range)
  const responses_within_date_filters = responses_within_temporal_filter({responses, temporal_filter_definition})
&nbsp;
  // Get bins
  const interval = get(temporal_filter_definition, 'interval', 'months')
  const bins = get_temporally_binned_responses({responses: responses_within_date_filters, interval})
&nbsp;
  <span class="missing-if-branch" title="if path not taken" >I</span>if (temporal_filter_definition.raw_responses) <span class="cstat-no" title="statement not covered" >return console.log(bins)</span>
&nbsp;
  // Work through responses in each bin, doing the aggregation
  bins.forEach(bin =&gt; {
    bin.sum_of_values = bin.responses.reduce((acc, response) =&gt; {
      return acc + response.value
    }, 0)
&nbsp;
    delete bin.responses
&nbsp;
    // const all_aggregations = INSTANCE_AGGREGATIONS
    // const denominator_for_bin = get_denominator_for_bin(bin)
    // const binned_aggregations = all_aggregations.map(aggregation =&gt; {
    //   return aggregation(bin.responses, denominator_for_bin)
    // })
    // return binned_aggregations
  })
&nbsp;
  return bins
}
&nbsp;
// Helpers, utilities
&nbsp;
const get_first_day_of = ({date, interval}) =&gt; {
  <span class="missing-if-branch" title="if path not taken" >I</span>if (interval === 'weeks') {
<span class="cstat-no" title="statement not covered" >    return moment(date).startOf('isoweek')</span>
  } else {
    return moment(date).startOf('month')
  }
}
&nbsp;
const format_as_bin_date = (moment_date) =&gt; {
  return moment_date.format('YYYY-MM-DD')
}
&nbsp;
const find_bin_for = ({response, bins, interval}) =&gt; {
  const first_day_of_period_for_response_date = get_first_day_of({date: response.recorded_on, interval})
  const response_date_as_time_slice = format_as_bin_date(first_day_of_period_for_response_date)
  return bins.find(bin =&gt; bin.time_slice === response_date_as_time_slice)
}
&nbsp;
export {get_temporally_binned_aggregations}
&nbsp;
&nbsp;</pre></td></tr>
</table></pre>
<div class='push'></div><!-- for sticky footer -->
</div><!-- /wrapper -->
<div class='footer quiet pad2 space-top1 center small'>
  Code coverage
  generated by <a href="http://istanbul-js.org/" target="_blank">istanbul</a> at Tue Sep 05 2017 11:26:05 GMT+0200 (SAST)
</div>
</div>
<script src="../../prettify.js"></script>
<script>
window.onload = function () {
        if (typeof prettyPrint === 'function') {
            prettyPrint();
        }
};
</script>
<script src="../../sorter.js"></script>
</body>
</html>
